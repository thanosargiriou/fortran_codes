C ******************************************************************
C
C PROGRAM COOLFIL.FOR
C PROGRAM TO FILTER THE GRANT SQUIRREL DATA FILES USED IN THE PASCOOL
C PROJECT
C BASED ON THE PASFIL CODE DEVELOPED BY H.A.L. VAN DIJK - G. VAN DER
C LINDEN - TNO BOUW, IN THE FRAME OF THE PASSYS PROJECT
C
C ATHANASSIOS A. ARGIRIOU, OTHONOS 65 GR-145 61 KIFISSIA, HELLAS
C tel: + 30-1-8088097
C
C**********************************************************************
      PROGRAM COOLFIL
C
      CHARACTER DATAFIL*13
      DIMENSION XMINV(10),XMAXV(10),XMING(10),XMAXG(10),XMINS(10),
     *XMAXS(10),ICRTYP(50),X(50),PREVAL(50),X1(50),XM(50),X2(50)  
C
      CALL OPENIN(DATAFIL,INLIN,NCOL,ITSTP,NCR,XMINV,XMAXV,XMING,XMAXG,
     *XMINS,XMAXS,ICRTYP)
C
      WRITE(*,'(A)')DATAFIL
C
C OPEN DATA FILE
      OPEN(100,FILE=DATAFIL)
C LOOKS FOR MISSING TIME STEPS  
C READ THE COMMENT LINES UNTIL BEGINNING OF DATA
      DO I=1,INLIN-1
      READ(100,*)
      ENDDO
      ICOUNT=0
C    
   10 ICOUNT=ICOUNT+1
      READ(100,1000,ERR=900)IDAY,IYEAR,IHOUR,MIN
 1000 FORMAT(1X,I3,1X,I2,1X,I2,1X,I2)
      IF (ICOUNT.EQ.1)GO TO 20
      IF(MIN.NE.MIN1.OR.IHOUR.NE.IHOUR1.OR.IDAY.NE.IDAY1) THEN
      WRITE(*,1100)IDAY,IYEAR,IHOUR,MIN
 1100 FORMAT(' TIME DISCONTINUITY DETECTED IN ',1X,I3,1X,I2,1X,I2,1X,I2)
      ENDIF
   20 MIN1=MIN+ITSTP
      IF(MIN1.GE.60)THEN
      MIN1=MIN1-60
      IHOUR1=IHOUR+1
      ELSE
      IHOUR1=IHOUR
      ENDIF
      IF(IHOUR1.GE.24)THEN
      IHOUR1=IHOUR1-24
      IDAY1=IDAY+1
      ELSE
      IDAY1=IDAY
      ENDIF
      IF(IDAY1.GT.365)THEN
      IDAY1=IDAY1-365
      IYEAR1=IYEAR+1
      ELSE
      IYEAR1=IYEAR
      ENDIF
      GO TO 10
 900  REWIND(100)
C CHECKS THE OTHER COLUMNS
      DO I=1,INLIN-1
      READ(100,*)
      ENDDO
      ICOUNT=0
   30 ICOUNT=ICOUNT+1
      READ(100,1200,ERR=910)IDAY,IYEAR,IHOUR,MIN,(X(J),J=1,NCOL)
 1200 FORMAT(1X,I3,1X,I2,1X,I2,1X,I2,3X,13F9.2)
      DO J=1,NCOL
C CHECKS THE RANGE OF THE VALUES
      IF(X(J).LT.XMINV(ICRTYP(J)).OR.X(J).GT.XMAXV(ICRTYP(J)))THEN
      WRITE(*,1300)J,IDAY,IYEAR,IHOUR,MIN,X(J)
 1300 FORMAT(' OUT OF RANGE ERROR DETECTED IN COLUMN ',I2, ' AT',
     *1X,I3,1X,I2,1X,I2,1X,I2,' OBSERVED VALUE ',F9.2)
      ENDIF
C CHECKS THE GRADIENT OF THE VALUES (IE THE DIFFERENCE FROM THE PREVIOUS
C TIME STEP)
      IF(ICOUNT.EQ.1)THEN
      PREVAL(J)=X(J)
      GOTO 40
      ELSE
      GRAD=X(J)-PREVAL(J)
      IF(GRAD.LT.XMING(ICRTYP(J)).OR.GRAD.GT.XMAXG(ICRTYP(J)))THEN
      WRITE(*,1400)J,IDAY,IYEAR,IHOUR,MIN,GRAD
 1400 FORMAT(' GRADIENT ERROR DETECTED IN COLUMN ',I2, ' AT',
     *1X,I3,1X,I2,1X,I2,1X,I2, ' GRADIENT VALUE= ',F9.2)
      ENDIF
      PREVAL(J)=X(J)
      ENDIF
C CHECKS THE OBSERVED PEAKS
 40   IF (ICOUNT.EQ.1) THEN
      X1(J)=X(J)
      GO TO 50
      ELSE
      	IF(ICOUNT.EQ.2)THEN
      	XM(J)=X(J)
        GOTO 50
      	ELSE
     	X2(J)=X(J)
         XDIF=XM(J)-(X2(J)+X1(J))/2.
         IF(XDIF.LT.XMINS(ICRTYP(J)).OR.XDIF.GT.XMAXS(ICRTYP(J)))THEN
         WRITE(*,1500)J,IDAY,IYEAR,IHOUR,MIN,X1(J),XM(J),X2(J)
 1500    FORMAT(' IMPORTANT PEAK DETECTED IN COLUMN ',I2, ' BEFORE',
     *1X,I3,1X,I2,1X,I2,1X,I2, ' VALUES = ',3F9.2)
         GOTO 60
         ENDIF
 60     X1(J)=XM(J)
        XM(J)=X2(J)
        ENDIF
      ENDIF
 50   ENDDO
      GOTO 30 
C
  910 CLOSE(100)      
      END
C
      SUBROUTINE OPENIN(DATAFIL,INLIN,NCOL,ITSTP,NCR,XMINV,XMAXV,
     *XMING,XMAXG,XMINS,XMAXS,ICRTYP)
C
      CHARACTER DATAFIL*13
      DIMENSION XMINV(10),XMAXV(10),XMING(10),XMAXG(10),XMINS(10),
     *XMAXS(10),ICRTYP(50)  
      OPEN(100,FILE='COOLFIL.IN')
      READ(100,*)
C READ THE DATA FILE NAME
      READ(100,'(A)')DATAFIL
C READ THE LINE WHERE DATA STARTS
      READ(100,*)
      READ(100,'(1X,I2)')INLIN
C READ THE NUMBER OF DATA COLUMNS
      READ(100,*)
      READ(100,*)NCOL
C READ THE DATA TIME STEP
      READ(100,*)
      READ(100,'(1X,I2)')ITSTP
C READ THE NO OF CRITERIA
      READ(100,*)
      READ(100,'(1X,I2)')NCR
C READ THE DATA OF THE CRITERIA
      DO I=1,NCR
      READ(100,*)
      READ(100,*)
      READ(100,*)XMINV(I),XMAXV(I),XMING(I),XMAXG(I),XMINS(I),XMAXS(I)
      END DO
C FOR EACH COLUMN, READ THE CORRESPONDING CRITERION
      READ(100,*)
      READ(100,*)
      DO I=1,NCOL
      READ(100,*)ICOL,ICRTYP(I)
      ENDDO
      CLOSE(100)
      RETURN
      END 