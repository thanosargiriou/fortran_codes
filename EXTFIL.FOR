C ******************************************************************
C
C PROGRAM EXTFIL.FOR
C PROGRAM TO FILTER THE RAW DATA FILES OF PASCOOL EXTENDED MONITORING
C
C BASED ON THE PASFIL CODE DEVELOPED BY H.A.L. VAN DIJK - G. VAN DER
C LINDEN - TNO BOUW, IN THE FRAME OF THE PASSYS PROJECT
C
C ATHANASSIOS A. ARGIRIOU, OTHONOS 65 GR-145 61 KIFISSIA, HELLAS
C tel: + 30-1-8088097
C 21-3-1994
C**********************************************************************
      PROGRAM EXTFIL
C
      CHARACTER DATAFIL*13,STRING1*17,OUTFIL*13,STRING*330
C DIMENSION (10) CORRESPONDS TO THE NO OF CRITERIA (DIFFERENT TYPES OF
C SENSORS USED).
C DIMENSION 50 CORRESPONDS TO THE MAX NO OF SENSORS USED IE TO THE MAX
C NO OF COLUMNS THAT CAN BE INCLUDED IN THE DATA FILE.
C
      DIMENSION XMINV(10),XMAXV(10),XMING(10),XMAXG(10),XMINS(10),
     *XMAXS(10),ICRTYP(50),X(50),PREVAL(50),X1(50),XM(50),X2(50)  
      DATA FLAG/-999.9/
C
C OPENS A LOG FILE
C 
      OPEN(999, FILE='EXTFIL.LOG')
      CALL OPENIN(INLIN,NCOL,ITSTP,NCR,XMINV,XMAXV,XMING,XMAXG,
     *XMINS,XMAXS,ICRTYP)
C
C READS THE INPUT ASCII FILE EXTINP
C IN THIS FILE THE FIRST LINE SHOWS THE NO OF DATAFILES TO BE PROCESSED
C AND THE FOLLOWING LINES CONTAIN THE FILE NAMES TO BE PROCESSED
C
      OPEN(901,FILE='EXTINP')
      READ(901,*)NOFIL
      DO IFI=1,NOFIL
      READ(901,'(A)')DATAFIL 
      WRITE(*,1601)DATAFIL
      WRITE(999,1601)DATAFIL
 1601 FORMAT(/,' FILE ACTUALLY PROCESSED ', A,/)
C
C OPEN DATA FILE
      OPEN(100,FILE=DATAFIL)
C
C CREATES AND OPENS THE OUTPUT FILE
C
      OUTFIL=DATAFIL(10:12)//'.CLE'
      OPEN(998,FILE=OUTFIL)
C CALCULATES THE SUNRISE AND SUNSET HOURS OF THE PARTICULAR DAY
C
      READ(100,1602)STRING1,JDAY
 1602 FORMAT(A,I3)
      CALL SDEC(JDAY,DEC)
      CALL RISET(37.9,DEC,SR,SST,DLG)
      SR=FLOAT(NINT(SR))*60.
      SST=FLOAT(NINT(SST))*60.
C
C LOOKS FOR MISSING TIME STEPS  
C READ THE COMMENT LINES UNTIL BEGINNING OF DATA
      DO I=1,INLIN-2
      READ(100,*)
      ENDDO
      ICOUNT=0
C    
   10 ICOUNT=ICOUNT+1
      READ(100,*,ERR=900)XTIM
      IF (ICOUNT.EQ.1)GO TO 20
      IF(XTIM.NE.XTIM1)THEN
      WRITE(*,1100)XTIM
      WRITE(999,1100)XTIM
 1100 FORMAT(' TIME DISCONTINUITY DETECTED IN ',F4.0)
      ENDIF
   20 XTIM1=XTIM+ITSTP
 900  REWIND(100)
C CHECKS THE OTHER COLUMNS
      DO I=1,INLIN-1
      READ(100,'(A)')STRING
      WRITE(998,'(A)')STRING
      ENDDO
      ICOUNT=0
   30 ICOUNT=ICOUNT+1
      READ(100,1200,ERR=910)XTIM,(X(J),J=1,NCOL)
 1200 FORMAT(47F7.1)
      DO J=1,NCOL
C CHECKS THE RANGE OF THE VALUES
      IF(X(J).EQ.-999.9)GOTO 50 
      IF(X(J).LT.XMINV(ICRTYP(J)).OR.X(J).GT.XMAXV(ICRTYP(J)))THEN
      X(J)=FLAG
      WRITE(*,1300)J,XTIM,X(J)
      WRITE(999,1300)J,XTIM,X(J)
 1300 FORMAT(' OUT OF RANGE ERROR DETECTED IN COLUMN ',I2, ' AT',
     *1X,F7.1,' OBSERVED VALUE ',F7.1)
      ENDIF
  70  CONTINUE
C CHECKS THE GRADIENT OF THE VALUES (IE THE DIFFERENCE FROM THE PREVIOUS
C TIME STEP)
      IF(ICOUNT.EQ.1)THEN
      PREVAL(J)=X(J)
      GOTO 40
      ELSE
      GRAD=X(J)-PREVAL(J)
      IF(GRAD.LT.XMING(ICRTYP(J)).OR.GRAD.GT.XMAXG(ICRTYP(J)))THEN
      WRITE(*,1400)J,XTIM,GRAD
      WRITE(999,1400)J,XTIM,GRAD
 1400 FORMAT(' GRADIENT ERROR DETECTED IN COLUMN ',I2, ' AT',
     *1X,F7.1, ' GRADIENT VALUE= ',F7.1)
      ENDIF
      PREVAL(J)=X(J)
      ENDIF
C CHECKS THE OBSERVED PEAKS
 40   IF (ICOUNT.EQ.1) THEN
      X1(J)=X(J)
      GO TO 50
      ELSE
      	IF(ICOUNT.EQ.2)THEN
      	XM(J)=X(J)
        GOTO 50
      	ELSE
     	X2(J)=X(J)
         XDIF=XM(J)-(X2(J)+X1(J))/2.
         IF(XDIF.LT.XMINS(ICRTYP(J)).OR.XDIF.GT.XMAXS(ICRTYP(J)))THEN
         WRITE(*,1500)J,XTIM,X1(J),XM(J),X2(J)
         WRITE(999,1500)J,XTIM,X1(J),XM(J),X2(J)
 1500    FORMAT(' IMPORTANT PEAK DETECTED IN COLUMN ',I2, ' BEFORE',
     *1X,F7.1, ' VALUES = ',3F7.1)
         GOTO 60
         ENDIF
 60     X1(J)=XM(J)
        XM(J)=X2(J)
        ENDIF
      ENDIF
 50   ENDDO
C CHECKS THE RELATION BETWEEN GLOBAL AND DIFFUSE RADIATION
C FOR THE PASCOOL EXTENDED MONITORING CLOBAL  RADIATION IS IN COLUMN 45
C                                     DIFFUSE RADIATION IS IN COLUMN 46
C
      IF(X(46).GT.X(45)) THEN
      WRITE(*,1600)XTIM
      WRITE(999,1600)XTIM
 1600 FORMAT(' DIFFUSE RADIATION > GLOBAL AT TIME ',F7.1)
      X(46)=X(45)           
      ENDIF
C
C SETS TO ZERO NOISE VALUES BEFORE SUNRISE AND AFTER SUNSET
C
      IF(XTIM.LT.SR.OR.XTIM.GT.SST)THEN
      X(45)=0
      X(46)=0
      ENDIF
C
      WRITE(998,1200)XTIM,(X(J),J=1,NCOL)        
      GOTO 30 
C
  910 CLOSE(100)
      CLOSE(998)
      ENDDO
      CLOSE(901)      
      CLOSE(999)
      END
C
      SUBROUTINE OPENIN(INLIN,NCOL,ITSTP,NCR,XMINV,XMAXV,
     *XMING,XMAXG,XMINS,XMAXS,ICRTYP)
C
      DIMENSION XMINV(10),XMAXV(10),XMING(10),XMAXG(10),XMINS(10),
     *XMAXS(10),ICRTYP(50)  
      OPEN(100,FILE='EXTFIL.IN')
C READ THE LINE WHERE DATA STARTS
      READ(100,*)
      READ(100,'(1X,I2)')INLIN
C READ THE NUMBER OF DATA COLUMNS
      READ(100,*)
      READ(100,*)NCOL
C READ THE DATA TIME STEP
      READ(100,*)
      READ(100,'(1X,I2)')ITSTP
C READ THE NO OF CRITERIA
      READ(100,*)
      READ(100,'(1X,I2)')NCR
C READ THE DATA OF THE CRITERIA
      DO I=1,NCR
      READ(100,*)
      READ(100,*)
      READ(100,*)XMINV(I),XMAXV(I),XMING(I),XMAXG(I),XMINS(I),XMAXS(I)
      END DO
C FOR EACH COLUMN, READ THE CORRESPONDING CRITERION
      READ(100,*)
      READ(100,*)
      DO I=1,NCOL
      READ(100,*)ICOL,ICRTYP(I)
      ENDDO
      CLOSE(100)
      RETURN
      END 
C
C*****************************************************
      SUBROUTINE SDEC(JDAY,DEC)
C*****************************************************
C THIS ROUTINE CALCULATES SOLAR DECLINATION (DEC)
C ATHANASSIOS ARGIRIOU 2 - 5 - 1990
C
      PI=4.*ATAN(1.)
C CALCULATION OF DECLINATION
 13   DEC=23.44*SIN(2.*PI*(FLOAT(JDAY)-81.)/365.)
      RETURN
      END
C
C
      SUBROUTINE RISET(SLAT,DEC,SR,SST,DLG)
C************************************************************
C CALCULATION OF THE SUNRISE AND SUNSET HOURS AND OF THE 
C DAY LENGTH
C SR:SUNRISE HOUR, SST:SUNSET HOUR, DLG:DAYLENGTH (hrs)
C ATHANASSIOS ARGIRIOU, 21 - 5 - 1990
C*************************************************************
C
      PI=4.*ATAN(1.)
      R=PI/180.
C
      SR=(360.-ACOS(-TAN(SLAT*R)*TAN(DEC*R))/R)/15.-12.
      DLG=(12.-SR)*2.
      SST=SR+DLG
C
      RETURN
      END

